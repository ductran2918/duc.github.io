<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>US Founders Map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  />

  <style>
    /* Full‑width map */
    #map {
      height: 600px;
      width: 100%;
    }

    /* Modal styles */
    dialog#detailModal {
      width: 80%;
      max-width: 600px;
      border: none;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.25);
      padding: 1em;
    }
    /* Dim background */
    dialog#detailModal::backdrop {
      background: rgba(0, 0, 0, 0.4);
    }

    /* Scrollable content */
    #modalContent {
      max-height: 70vh;
      overflow-y: auto;
      margin-top: 1em;
    }

    /* Table styling */
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th,
    td {
      border: 1px solid #ccc;
      padding: 4px;
      text-align: left;
    }

    /* Close button */
    button#closeModal {
      float: right;
    }
  </style>
</head>
<body>
  <!-- Map container -->
  <div id="map"></div>

  <!-- Detail modal -->
  <dialog id="detailModal">
    <button id="closeModal">Close</button>
    <div id="modalContent"></div>
  </dialog>

  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <script>
    // Initialize the Leaflet map
    const map = L.map("map").setView([37.8, -96], 4);

    // (Optional) Add an OpenStreetMap tile layer
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // Store founders by state
    const stateData = {};

    // Load and parse the CSV
    Papa.parse("data_seafounders_us.csv", {
      download: true,
      header: true,
      complete: function (results) {
        // Group rows by state
        results.data.forEach((d) => {
          const st = d.state;
          if (!stateData[st]) stateData[st] = [];
          stateData[st].push(d);
        });
        drawMap();
      }
    });

    function drawMap() {
      // Build an array of counts (include zero)
      const counts = Object.values(stateData).map((arr) => arr.length);
      counts.push(0);
      const maxCount = d3.max(counts);
      const minCount = d3.min(counts);
      const interval = (maxCount - minCount) / 5;
      const breaks = d3.range(1, 6).map((i) => minCount + i * interval);

      // Five‑step blue palette from D3
      const palette = d3.schemeBlues[5];

      // Color helper
      function getColor(count) {
        for (let i = 0; i < breaks.length; i++) {
          if (count <= breaks[i]) return palette[i];
        }
        return palette[palette.length - 1];
      }

      // Fetch US states GeoJSON (lower 48 + HI)
      fetch(
        "https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json"
      )
        .then((res) => res.json())
        .then((geojson) => {
          L.geoJson(geojson, {
            // Exclude Alaska
            filter: (f) => f.properties.name !== "Alaska",
            style: (feature) => {
              const c = (stateData[feature.properties.name] || []).length;
              return {
                color: "#fff",
                weight: 1,
                fillOpacity: 0.7,
                fillColor: getColor(c)
              };
            },
            onEachFeature: (feature, layer) => {
              const name = feature.properties.name;
              const cnt = (stateData[name] || []).length;

              // Hover tooltip
              layer.on("mouseover", (e) => {
                layer
                  .bindTooltip(
                    `${cnt} founders – Click to see details`,
                    { sticky: true }
                  )
                  .openTooltip(e.latlng);
              });
              layer.on("mouseout", () => {
                layer.closeTooltip();
              });

              // Click: show modal
              layer.on("click", () => showModal(name));
            }
          }).addTo(map);
        });
    }

    // Modal handling
    const modal = document.getElementById("detailModal");
    const modalContent = document.getElementById("modalContent");
    document.getElementById("closeModal").addEventListener("click", () => {
      modal.close();
    });

    // Build and show the detail table
    function showModal(stateName) {
      const list = stateData[stateName] || [];
      let html = `<h3>Founders in ${stateName} (${list.length})</h3>`;
      html +=
        "<table><thead><tr><th>Founder</th><th>State</th><th>Company</th><th>Founded Year</th><th>Vertical</th></tr></thead><tbody>";
      list.forEach((d) => {
        html += `<tr>
          <td>${d.founder}</td>
          <td>${d.state}</td>
          <td>${d.company}</td>
          <td>${d.founded_year}</td>
          <td>${d.vertical}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      modalContent.innerHTML = html;
      modal.showModal();
    }
  </script>
</body>
</html>
